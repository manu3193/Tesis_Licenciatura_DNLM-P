\chapter{Resultados y an√°lisis}
\label{ch:res}

Los experimentos realizados utilizan un tama\~no por defecto de la imagen de entrada ($1024 \times 1024$), ventana de b\'usqueda \Omega  ($21\times21$) y vecindario \omega ($7\times7$), excepto donde se indica lo contrario. Adem\'as, todos los resultados reportados corresponden al promedio de 10 ejecuciones para cada programa evaluado.  Para evaluar las implementaciones paralelas se utiliza la cantidad de hilos que mejor resultado muestra. Esto es, 256 hilos para el filtro DNLM-P, 128 hilos para el filtro DNLM-IFFTT-P y 32 hilos para el filtro DNLM-MOAS-P, seg\'un se observa en la Figura \ref{fig:scalability}. Las implementaciones secuenciales del filtro DNLM utilizan primitivas que vectorizan autom\'aticamente las operaciones par el conjunto de instrucciones SIMD soportado por los procesadores Xeon Phi KNL.

Las tablas \ref{tabla:vec_dnlm}, \ref{tabla:vec_dnlm_iifft} y \ref{tabla:vec_dnlm_moas} muestran la comparaci\'on en la aceleraci\'on obtenida al utilizar conjuntos de instrucciones SIMD (AVX, AVX2 y AVX512) con diferente tama\~no de registro (128, 256 y 512 bytes respectivamente) para cada una de las versiones secuenciales del filtro DNLM evaluadas. 


%Vectorization table for DNLM-------------------------------
\begin{table}
\protect\caption{Efecto del cambio en el conjunto de instrucciones SIMD para implementaciones secuenciales del filtro DNLM usando una imagen de  $1024 \times 1024$ pixeles, con tama\~no de ventana de b\'usqueda de $21 \times 21$ y vencidario de $7 \times 7$ pixeles. \label{tabla:vec_dnlm}}
\centering
\begin{tabular}{lrrr}
SIMD ISA & Duraci\'on(s)& Coef. de var. & Aceleraci\'on \tabularnewline
\hline
AVX & $288.85\pm0.33$ & $0.0$ & $1$\tabularnewline
AVX2 & $146.31\pm0.03$ & $0.00$ & $1.97$\tabularnewline
AVX512 & $146.51\pm 1.30$ & $0.01$ & $1.97$ \tabularnewline
\end{tabular}
\end{table}

El filtro DNLM presenta una aceleraci\'on proporcional a la diferencia en el tama\~no de registro entre AVX y AVX2; pero no en el caso de AVX y AVX512, en el que la aceleraci\'on no aumenta. Esto hace indicar que el aumento en el empaquetamiento de instrucciones entre AVX2 y AVX512 no tiene efecto considerable en la versi\'on no optimizada del filtro . Se puede apreciar en la Tabla \ref{tabla:vec_dnlm} c\'omo presenta pr\acticamente una nula diferencia entre la vectorizaci\'on con el conjunto de instrucciones AVX2 y AVX512. 

%Vectorization table for DNLM-IIFFT-------------------------------
\begin{table}
\protect\caption{Efecto del cambio en el conjunto de instrucciones SIMD para implementaciones secuenciales del filtro DNLM-IIFFT usando una imagen de  $1024 \times 1024$ pixeles, con tama\~no de ventana de b\'usqueda de $21 \times 21$ y vencidario de $7 \times 7$ pixeles. \label{tabla:vec_dnlm_iifft}}
\centering
\begin{tabular}{lrrr}
SIMD ISA & Duraci\'on (s)& Coef. de var. & Aceleraci\'on \tabularnewline
\hline
AVX & $62.79\pm0.03$ & $0.0$ & $1.00$\tabularnewline
AVX2 & $62.30\pm0.31$ & $0.01$ & $1.09$\tabularnewline
AVX512 & $62.27\pm 0.06$ & $0.00$ & $1.09$ \tabularnewline
\end{tabular}
\end{table}


En el caso de la optimizaci\'on DNLM-IIFFT, el comportamiento mostrado en la Tabla \ref{tabla:vec_dnlm_iifft}es similar a los resultados anteriores pero con una aceleraci\'on menor, sin obtener la ventaja te\'orica entre AVX, AVX2 y AVX512. Una posible causa es por los par\'ametros utilizados para el tama\~no de ventana y vecindario, los cuales limitan la cantidad de pixeles utilizados en el c\'alculo de los pesos, y por lo tanto, un menor grado de aprovechamiento del empaquetado que ofrecen las instrucciones SIMD para ejecutar instrucciones sobre un conjunto de datos.

%Vectorization table for DNLM-MOAS-------------------------------
\begin{table}
\protect\caption{Efecto del cambio en el conjunto de instrucciones SIMD para implementaciones secuenciales del filtro DNLM-MOAS usando una imagen de  $1024 \times 1024$ pixeles, con tama\~no de ventana de b\'usqueda de $21 \times 21$ y vencidario de $7 \times 7$ pixeles. \label{tabla:vec_dnlm_moas}}
\centering
\begin{tabular}{lrrr}
SIMD ISA & Duraci\'on (s)& Coef. de var. & Aceleraci\'on \tabularnewline
\hline
AVX & $2.82\pm0.03$ & $0.0$ & $1$\tabularnewline
AVX2 & $2.13\pm0.03$ & $0.00$ & $1.32$\tabularnewline
AVX512 & $2.14\pm 0.03$ & $0.00$ & $1.32$ \tabularnewline
\end{tabular}
\end{table}



Los resultados mostrados en la Tabla \ref{tabla:vec_dnlm_moas} comparten un comportamiento similar a los filtros DNLM y DNLM-IIFFT. 



Una comparaci\'on del tiempo de ejecuci\'on de las implementaciones del filtro DNLM se muestra en la Tabla \ref{tabla:speedup}, la cual revela que la aceleraci\'on del filtro DNLM-MOAS basado en el enfoque de media movil de Condat \cite{Condat2010} sobrepasa por un gran margen ($88.30X$) la implementaci\'on DNLM-IIFFT \cite{CalderonRamirez2017} basada en la optimizaci\'on de Wang para el filtro NLM \cite{wang2006fast} que emplea la FFT e im\'agenes integrales. El coeficiente de variabilidad de todas las implementaciones es igual o menor que $0.06$. 
De la misma manera, la implementaci\'on paralela DNLM-MOAS-P es la m\'as r\'apida, logrando alcanzar una aceleraci\'on de $665.63X$ aobre la implementaci\'on secuencial original DNLM. Sin embargo, las implementaciones paralelas DNLM-IIFFT-P y DNLM-P muestran aceleraciones mayores a $100X$ en comparaci\'on a la versi\'on secuencial original DNLM.



%Speedup table---------------------------------------
\begin{table}[H]
\protect\caption{Aceleraci\'on promedio para las implementaciones del filtro DNLM usando una imagen de  $1024 \times 1024$ pixeles, con tama\~no de ventana de b\'usqueda de $21 \times 21$ y vencidario de $7 \times 7$ pixeles. \label{tabla:speedup}}
\centering
\begin{tabular}{lrrr}
Filtro & Duraci\'on (s)& Coef. de var. & Aceleraci\'on \tabularnewline
\hline
DNLM & $163.71\pm1.32$ & $0.01$ & $1$\tabularnewline
DNLM-IIFFT & $76.68\pm0.06$ & $0.00$ & $2.14$\tabularnewline
DNLM-MOAS & $1.81\pm 0.01$ & $0.00$ & $90.44$ \tabularnewline
DNLM-P & $1.5\pm0.10$ & $0.06$ & $108.99$\tabularnewline
DNLM-IIFFT-P & $1.00\pm0.00$ & $0.00$ & $163.92$ \tabularnewline 
DNLM-MOAS-P & $\boldsymbol{0.25\pm0.00}$ & $\boldsymbol{0.01}$ &  $\boldsymbol{665.63}$\tabularnewline
\end{tabular}
\end{table}


El efecto en el cambio del tama\~no de imagen en la aceleraci\'on total de la implementaci\'on DNLM-MOAS-P se muestra en la Tabla \ref{tabla:scala1}. Se aprecia c\'omo la aceleraci\'on de la implementaci\'on DNLM-MOAS-P incrementa significativamente cuando el tama\~no de la imagen aumenta, con aceleraciones desde $206.95X$ a $728.66$ para tama\~nos de imagen desde $256 \times 256$ a $2048 \times 2048$ pixeles. 
De la misma manera, se observa una tendencia similar al aumentar el tama\~no de ventana y vecindario, como se muestra en la tabla \ref{tabla:scala2}. En este caso, se consigue una aceleraci\'on desde $222.43X$ al utilizar un tama\~no de ventana de b\'usqueda de $11 \times 11$ y de vecindario de $11 \times 11$, hasta llegar a una aceleraci\'on de $1662.90X$ al utilizar una ventana de b\'usqueda de $41 \times 41$ pixeles y vecindario de $11 \times 11$ pixeles. Esto es en parte debido a la diferencia entre las funciones de costo de las implementaciones DNLM y DNLM-MOAS detalladas en la Secci\'on \ref{ch:marco_opt} y al alto grado de paralelismo de la plataforma Xeon Phi KNL.


%Scalability table #1--------------------------------
\begin{table}[H]
\protect\caption{Effecto al cambiar el tama\~no de la imagen de entrada para el filtro DNLM y DNLM-MOAS-P usando una imagen de entrada de  $1024 \times 1024$ pixeles, con tama\~no de ventana de b\'usqueda de $21 \times 21$ y vencidario de $7 \times 7$ pixeles. \label{tabla:scala1}}
\centering
\begin{tabular}{lrrr}
Tama\~no de imagen & DNLM & DNLM-MOAS-P & Aceleraci\'on \tabularnewline
\hline
$256 \times 256$ & $10.26\pm0.02$ & $0.05\pm0.00$ & $206.95$ \tabularnewline
$512 \times 512$ & $40.95\pm0.35$ & $0.11\pm0.00$ & $377.70$ \tabularnewline
$1024 \times 1024$ & $163.18\pm0.03$ & $0.25\pm0.01$ & $662.27$ \tabularnewline
$2048 \times 2048$ & $654.15\pm5.64$ & $0.90\pm0.01$ & $728.66$ \tabularnewline
\end{tabular}
\end{table}


%Scalability table #2--------------------------------
\begin{table}[H]
\protect\caption{Effecto al cambiar el tama\~no de ventana de b\'usqueda ($\Omega$) y vecindario ($\Phi$) para el filtro DNLM y DNLM-MOAS-P usando una imagen de entrada de  $1024 \times 1024$ pixeles. \label{tabla:scala2}}
\centering
\begin{tabular}{lrrrr}
Tama\~no de $\Omega$  & Tama\~no de $\omega$ & DNLM & DNLM-MOAS-P & Aceleraci\'on \tabularnewline
\hline
$11 \times 11$ & $5 \times 5$ & $42.46\pm0.46$ & $0.19\pm0.00$ & $222.43$ \tabularnewline
 & $7 \times 7$ & $46.73\pm0.41$ & $0.20\pm0.00$ & $238.11$ \tabularnewline
 & $11 \times 11$ & $61.61\pm0.40$ & $0.20\pm0.00$ & $306.38$ \tabularnewline
$21 \times 21$ & $5 \times 5$ & $147.96\pm1.41$ & $0.25\pm0.00$ & $595.86$ \tabularnewline
 & $7 \times 7$ & $163.62\pm1.41$ & $0.25\pm0.01$ & $660.36$ \tabularnewline
 & $11 \times 11$ & $218.32\pm1.87$ & $0.25\pm0.00$ & $880.76$ \tabularnewline
 $41 \times 41$ & $5 \times 5$ & $485.15\pm5.31$ & $0.45\pm0.01$ & $1071.00$ \tabularnewline
 & $7 \times 7$ & $546.90\pm10.10$ & $0.46\pm0.01$ & $1201.83$ \tabularnewline
 & $11 \times 11$ & $752.35\pm5.41$ & $0.45\pm0.00$ & $1662.90$ \tabularnewline
\end{tabular}
\end{table}




El efecto de variar el n\'umero de hilos de ejecuci\'on para las implementaciones paralelas del filtro DNLM se muestra en la Figura \ref{fig:scalability}. La implementaci\'on paralela DNLM-MOAS-P alcanza el menor tiempo de ejecuci\'on reportado con $0.25$s utilizando s\'olo 32 threads. Este comportamiento se explica debido a que el filtro DNLM-MOAS presenta un mayor ancho de banda de memoria en comparaci\'on con las otras implementaciones. Esto permite al calendarizador asignar un thread a cada una de las 32 celdas de n\'ucleos presentes en la arquitectura Xeon Phi KNL y as\'i aprovechar mayor ancho de banda y localidad de cach\'e presente en la celda, seg\'un se detalla en la secci\'on \ref{ch:marco_xeonphi}. 





%GRAPHS-----------------------------------------------


\begin{figure}[H]
\centering
  \begin{tikzpicture}
      \begin{semilogyaxis}[
          height=0.3\textheight,
          width=0.5\textwidth,
          xlabel= \# Hilos,
          ylabel=Duraci\'on (s),
          xmin=1,
          xmax=260,
          scaled x ticks = false
  ]
           \addplot[mark=*,ForestGreen] table[x=Threads,y=Time] {data/scaling_original.txt};
           \addlegendentry{DNLM}
          \addplot[mark=x,Cerulean] table[x=Threads,y=Time] {data/scaling_iifft.txt};
          \addlegendentry{DNLM-IIFFT}
          \addplot[mark=triangle,Orange] table[x=Threads,y=Time] {data/scaling_condat.txt};
          \addlegendentry{DNLM-MOAS}
      \end{semilogyaxis}
      \label{fig:scalability}
  \end{tikzpicture}
  \caption[Escalabilidad de la implementaci\'on paralela para cada versi\'on del filtro DNLM, desde 1 a 256 hilos de ejecuci\'on.]{Escalabilidad de la implementaci\'on paralela para cada versi\'on del filtro DNLM, desde 1 a 256 hilos de ejecuci\'on. El tama\~no de la imagen de entrada es de $1024\times1024$, con tama\~no de ventana de b\'usqueda de $21 \times 21$ y vencidario de $7 \times 7$ pixeles.}
  \end{figure}
  
  Siguiendo la misma tendencia, la eficiencia de las implementaciones paralelas se muestran en la Figura \ref{fig:efficiency}. Se aprecia que la eficiencia de las implementaciones DNLM-P y DNLM-IIFFT-P presentan una disminuci\'on sostenida en la eficiencia al aumentar la cantidad de hilos de ejecuci\'on. En el caso de la implementaci\'on DNLM-MOAS-P, presenta un mayor ancho de banda de memoria, por lo tanto la sobrecarga en cuanto a transferencia de datos en memoria aumenta al aumentar la cantidad de hilos de ejecuci\'on, provocando una ca\'ida considerablemente m\'as pronunciada en la curva de eficiencia.
  
  \begin{figure}[H]
  \centering
  \begin{tikzpicture}
      \begin{axis}[
          height=0.3\textheight,
          width=0.5\textwidth,
          xlabel= \# Hilos,
          ylabel=Eficiencia,
          xmin=1,
          xmax=260,
          %scaled x ticks = false
  ]
           \addplot[mark=*,ForestGreen] table[x=Threads,y=Efficiency] {data/eficiency_original.txt};
           \addlegendentry{DNLM}
          \addplot[mark=x,Cerulean] table[x=Threads,y=Efficiency] {data/eficiency_iifft.txt};
          \addlegendentry{DNLM-IIFFT}
          \addplot[mark=triangle,Orange] table[x=Threads,y=Efficiency] {data/efficiency_condat.txt};
          \addlegendentry{DNLM-MOAS}
      \end{axis}
      \label{fig:efficiency}
  \end{tikzpicture}
  \caption[Eficiencia de la implementaci\'on paralela para cada versi\'on del filtro DNLM, desde 1 a 256 hilos de ejecuci\'on.]{Eficiencia de la implementaci\'on paralela para cada versi\'on del filtro DNLM, desde 1 a 256 hilos de ejecuci\'on. El tama\~no de la imagen de entrada es de $1024\times1024$, con tama\~no de ventana de b\'usqueda de $21 \times 21$ y vencidario de $7 \times 7$ pixeles.}
  \end{figure}