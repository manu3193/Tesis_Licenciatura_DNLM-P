\chapter{Resultados y análisis}
\label{ch:res}

Los experimentos realizados utilizan un tama\~no por defecto de la imagen de entrada ($1024 \times 1024$), ventana de búsqueda $\Omega$  ($21 \times 21$) y vecindario $\omega$ ($7 \times 7$), excepto donde se indica lo contrario. Adem\'as, todos los resultados reportados corresponden al promedio de 10 ejecuciones para cada programa evaluado.  Para evaluar las implementaciones paralelas se utiliza la cantidad de hilos que mejor resultado muestra. Esto es, 256 hilos para el filtro DNLM-P, 128 hilos para el filtro DNLM-IFFTT-P y 32 hilos para el filtro DNLM-MA-P, según se observa en la Figura \ref{fig:scalability}. Las implementaciones secuenciales del filtro DNLM utilizan primitivas que vectorizan automáticamente las operaciones para el conjunto de instrucciones SIMD soportado por los procesadores Xeon Phi KNL.

Las tablas \ref{tabla:vec_dnlm}, \ref{tabla:vec_dnlm_iifft} y \ref{tabla:vec_dnlm_MA} muestran la comparación en la aceleración obtenida al utilizar conjuntos de instrucciones SIMD (AVX, AVX2 y AVX512) con diferente tama\~no de registro (128, 256 y 512 bytes respectivamente) para cada una de las versiones secuenciales del filtro DNLM evaluadas. 


%Vectorization table for DNLM-------------------------------
\begin{table}
\protect\caption[Efecto de vectorización con instrucciones SIMD para el filtro DNLM]{Efecto del cambio en el conjunto de instrucciones SIMD para implementaciones secuenciales del filtro DNLM usando una imagen de  $1024 \times 1024$ pixeles, con tama\~no de ventana de búsqueda de $21 \times 21$ y vencidario de $7 \times 7$ pixeles. \label{tabla:vec_dnlm}}
\centering
\begin{tabular}{lrrr}
SIMD ISA & Duración [s]& Coef. de var. & Aceleración [$\times$] \tabularnewline
\hline
AVX & $288.85\pm0.33$ & $0.0$ & $1$\tabularnewline
AVX2 & $146.31\pm0.03$ & $0.00$ & $1.97$\tabularnewline
AVX512 & $146.51\pm 1.30$ & $0.01$ & $1.97$ \tabularnewline
\end{tabular}
\end{table}

El filtro DNLM presenta una aceleración proporcional a la diferencia en el tama\~no de registro entre AVX y AVX2; pero no en el caso de AVX y AVX512, en el que la aceleración no aumenta. Esto hace indicar que el aumento en el empaquetamiento de instrucciones entre AVX2 y AVX512 no tiene efecto considerable en la versión no optimizada del filtro . 



%Vectorization table for DNLM-IIFFT-------------------------------
\begin{table}
\protect\caption[Efecto de vectorización con instrucciones SIMD para el filtro DNLM-IIFFT]{Efecto del cambio en el conjunto de instrucciones SIMD para implementaciones secuenciales del filtro DNLM-IIFFT usando una imagen de  $1024 \times 1024$ pixeles, con tama\~no de ventana de búsqueda de $21 \times 21$ y vencidario de $7 \times 7$ pixeles. \label{tabla:vec_dnlm_iifft}}
\centering
\begin{tabular}{lrrr}
SIMD ISA & Duración [s]& Coef. de var. & Aceleración [$\times$] \tabularnewline
\hline
AVX & $62.79\pm0.03$ & $0.0$ & $1.00$\tabularnewline
AVX2 & $62.30\pm0.31$ & $0.01$ & $1.09$\tabularnewline
AVX512 & $62.27\pm 0.06$ & $0.00$ & $1.09$ \tabularnewline
\end{tabular}
\end{table}


En el caso de la optimización DNLM-IIFFT, el comportamiento mostrado en la Tabla \ref{tabla:vec_dnlm_iifft}es similar a los resultados anteriores pero con una aceleración menor, sin obtener la ventaja teórica entre AVX, AVX2 y AVX512. Una posible causa es por los parámetros utilizados para el tama\~no de ventana y vecindario, los cuales limitan la cantidad de pixeles utilizados en el cálculo de los pesos, y por lo tanto, un menor grado de aprovechamiento del empaquetado que ofrecen las instrucciones SIMD para ejecutar instrucciones sobre un conjunto de datos.

%Vectorization table for DNLM-MA-------------------------------
\begin{table}
\protect\caption[Efecto de vectorización con instrucciones SIMD para el filtro DNLM-MA]{Efecto del cambio en el conjunto de instrucciones SIMD para implementaciones secuenciales del filtro DNLM-MA usando una imagen de  $1024 \times 1024$ pixeles, con tama\~no de ventana de búsqueda de $21 \times 21$ y vencidario de $7 \times 7$ pixeles. \label{tabla:vec_dnlm_MA}}
\centering
\begin{tabular}{lrrr}
SIMD ISA & Duración [s]& Coef. de var. & Aceleración [$\times$] \tabularnewline
\hline
AVX & $2.82\pm0.03$ & $0.0$ & $1$\tabularnewline
AVX2 & $2.13\pm0.03$ & $0.00$ & $1.32$\tabularnewline
AVX512 & $2.14\pm 0.03$ & $0.00$ & $1.32$ \tabularnewline
\end{tabular}
\end{table}

La tabla \ref{tabla:vpui} muestra las métricas CPI y VPUi para los filtros DNLM, DNLM-IIFFT y DNLM-MA con un solo hilo de ejecución. Se observa que la intensidad de uso de la VPU es casi la máxima para todos los filtros, por lo tanto se deduce que la vectorización es casi total.

\begin{table}
\protect\caption[Métricas CPI y VPUi de los filtros con 1 hilo]{CPI y VPUi de  la región paralelizada cambio en el conjunto de instrucciones SIMD para implementaciones secuenciales del filtro DNLM usando una imagen de  $1024 \times 1024$ pixeles, con tama\~no de ventana de búsqueda de $21 \times 21$ y vencidario de $7 \times 7$ pixeles. \label{tabla:vpui}}
\centering
\begin{tabular}{lrr}
Filtro  & CPI & VPUi \tabularnewline
\hline
DNLM & $1.5$ & $0.95$\tabularnewline
DNLM-IIFFT &$2.82$ & $0.81$  \tabularnewline
DNLM-MA &$3.18$&  $1$  \tabularnewline
\end{tabular}
\end{table}

Los resultados mostrados en la Tabla \ref{tabla:vec_dnlm_MA} comparten un comportamiento similar a los filtros DNLM y DNLM-IIFFT. 



Una comparación del tiempo de ejecución de las implementaciones del filtro DNLM se muestra en la Tabla \ref{tabla:speedup}, la cual revela que la aceleración del filtro DNLM-MA basado en el enfoque de media movil de Condat \cite{Condat2010} sobrepasa por un gran margen ($88.30\times$) la implementación DNLM-IIFFT \cite{CalderonRamirez2017} basada en la optimización de Wang para el filtro NLM \cite{wang2006fast} que emplea la FFT e imágenes integrales. El coeficiente de variación de todas las implementaciones es igual o menor que $0.06$. 
De la misma manera, la implementación paralela DNLM-MA-P es la más rápida, logrando alcanzar una aceleración de $665.63\times$ aobre la implementación secuencial original DNLM. Sin embargo, las implementaciones paralelas DNLM-IIFFT-P y DNLM-P muestran aceleraciones mayores a $100\times$ en comparación a la versión secuencial original DNLM.
La tabla \ref{tabla:speedup} también muestra que el filtro DNLM-MA-P obtiene una aceleración menor ($7.24\times$) en comparación con el DNLM-IIFFT-P ($76.68\times$) y el DNLM-P ($109.14\times$) respecto a sus versiones con un sólo hilo de ejecución.



%Speedup table---------------------------------------
\begin{table}
\protect\caption[Aceleración promedio de optimizaciones del filtro DNLM]{Aceleración promedio para las optimizaciones del filtro DNLM usando una imagen de  $1024 \times 1024$ pixeles, con tama\~no de ventana de búsqueda de $21 \times 21$ y vencidario de $7 \times 7$ pixeles. \label{tabla:speedup}}
\centering
\begin{tabular}{lrrr}
Filtro & Duración [s]& Coef. de var. & Aceleración [$\times$]\tabularnewline
\hline
DNLM & $163.71\pm1.32$ & $0.01$ & $1$\tabularnewline
DNLM-IIFFT & $76.68\pm0.06$ & $0.00$ & $2.14$\tabularnewline
DNLM-MA & $1.81\pm 0.01$ & $0.00$ & $90.44$ \tabularnewline
DNLM-P & $1.5\pm0.10$ & $0.06$ & $108.99$\tabularnewline
DNLM-IIFFT-P & $1.00\pm0.00$ & $0.00$ & $163.92$ \tabularnewline 
DNLM-MA-P & $\boldsymbol{0.25\pm0.00}$ & $\boldsymbol{0.01}$ &  $\boldsymbol{665.63}$\tabularnewline
\end{tabular}
\end{table}


El efecto en el cambio del tama\~no de imagen en la aceleración total de la implementación DNLM-MA-P se muestra en la Tabla \ref{tabla:scala1}. Se aprecia cómo la aceleración de la implementación DNLM-MA-P incrementa significativamente cuando el tama\~no de la imagen aumenta, con aceleraciones desde $206.95\times$ a $728.66$ para tama\~nos de imagen desde $256 \times 256$ a $2048 \times 2048$ pixeles. La máxima aceleración converge tal y como lo demuestra el tiempo de filtrado de la muestra de $4096\times 4096$ pixeles.  
De la misma manera, se observa una tendencia similar al aumentar el tama\~no de ventana y vecindario, como se muestra en la tabla \ref{tabla:scala2}. En este caso, se consigue una aceleración desde $222.43\times$ al utilizar un tama\~no de ventana de búsqueda de $11 \times 11$ y de vecindario de $11 \times 11$, hasta llegar a una aceleración de $1662.90\times$ al utilizar una ventana de búsqueda de $41 \times 41$ pixeles y vecindario de $11 \times 11$ pixeles. Esto es en parte debido a la diferencia entre las funciones de costo de las implementaciones DNLM y DNLM-MA detalladas en la Sección \ref{ch:marco_opt} y al alto grado de paralelismo de la plataforma Xeon Phi KNL.


%Scalability table #1--------------------------------
\begin{table}
\protect\caption[Efecto al cambiar tama\~no de imagen de entrada]{Effecto al cambiar el tama\~no de la imagen de entrada para el filtro DNLM y DNLM-MA-P usando una imagen de entrada de  $1024 \times 1024$ pixeles, con tama\~no de ventana de búsqueda de $21 \times 21$ y vencidario de $7 \times 7$ pixeles. \label{tabla:scala1}}
\centering
\begin{tabular}{lrrr}
Tama\~no de imagen & DNLM [s]& DNLM-MA-P [s]& Aceleración [$\times$] \tabularnewline
\hline
$256 \times 256$ & $10.26\pm0.02$ & $0.05\pm0.00$ & $206.95$ \tabularnewline
$512 \times 512$ & $40.95\pm0.35$ & $0.11\pm0.00$ & $377.70$ \tabularnewline
$1024 \times 1024$ & $163.18\pm0.03$ & $0.25\pm0.01$ & $662.27$ \tabularnewline
$2048 \times 2048$ & $654.15\pm5.64$ & $0.90\pm0.01$ & $728.66$ \tabularnewline
$4096 \times 4096$ & $2629.59\pm31.26$ & $3.45\pm0.01$ & $761.63$ \tabularnewline
\end{tabular}
\end{table}


%Scalability table #2--------------------------------
\begin{table}
\protect\caption[Efecto al cambiar parámetros $\Omega$ y $\Phi$]{Effecto al cambiar el tama\~no de ventana de búsqueda ($\Omega$) y vecindario ($\Phi$) para el filtro DNLM y DNLM-MA-P usando una imagen de entrada de  $1024 \times 1024$ pixeles. \label{tabla:scala2}}
\centering
\begin{tabular}{lrrrr}
$\Omega$  & $\omega$ & DNLM [s]& DNLM-MA-P [s]& Aceleración [$\times$]\tabularnewline
\hline
$11 \times 11$ & $5 \times 5$ & $42.46\pm0.46$ & $0.19\pm0.00$ & $222.43$ \tabularnewline
 & $7 \times 7$ & $46.73\pm0.41$ & $0.20\pm0.00$ & $238.11$ \tabularnewline
 & $11 \times 11$ & $61.61\pm0.40$ & $0.20\pm0.00$ & $306.38$ \tabularnewline
$21 \times 21$ & $5 \times 5$ & $147.96\pm1.41$ & $0.25\pm0.00$ & $595.86$ \tabularnewline
 & $7 \times 7$ & $163.62\pm1.41$ & $0.25\pm0.01$ & $660.36$ \tabularnewline
 & $11 \times 11$ & $218.32\pm1.87$ & $0.25\pm0.00$ & $880.76$ \tabularnewline
 $41 \times 41$ & $5 \times 5$ & $485.15\pm5.31$ & $0.45\pm0.01$ & $1071.00$ \tabularnewline
 & $7 \times 7$ & $546.90\pm10.10$ & $0.46\pm0.01$ & $1201.83$ \tabularnewline
 & $11 \times 11$ & $752.35\pm5.41$ & $0.45\pm0.00$ & $1662.90$ \tabularnewline
\end{tabular}
\end{table}




El efecto de variar el número de hilos de ejecución para las implementaciones paralelas del filtro DNLM se muestra en la Figura \ref{fig:scalability}. La implementación paralela DNLM-MA-P alcanza el menor tiempo de ejecución reportado con $0.25$s utilizando sólo 32 threads. Este comportamiento se explica debido a que el filtro DNLM-MA presenta un mayor ancho de banda de memoria en comparación con las otras implementaciones. Esto permite al calendarizador asignar un thread a cada una de las 32 celdas de núcleos presentes en la arquitectura  KNL y así aprovechar mayor ancho de banda de caché presente en la celda, según se detalla en la sección \ref{ch:marco_xeonphi}. 





%GRAPHS-----------------------------------------------


\begin{figure}
\centering
  \begin{tikzpicture}
      \begin{semilogyaxis}[
          height=0.3\textheight,
          width=0.5\textwidth,
          xlabel= \# Hilos,
          ylabel=Duración (s),
          xmin=1,
          xmax=260,
          scaled x ticks = false
  ]
           \addplot[mark=*] table[x=Threads,y=Time] {data/scaling_original.txt};
           \addlegendentry{DNLM}
          \addplot[mark=x] table[x=Threads,y=Time] {data/scaling_iifft.txt};
          \addlegendentry{DNLM-IIFFT}
          \addplot[mark=triangle] table[x=Threads,y=Time] {data/scaling_condat.txt};
          \addlegendentry{DNLM-MA}
      \end{semilogyaxis}
  \end{tikzpicture}
  \caption[Escalabilidad de las implementaciones paralelas del filtro DNLM]{Escalabilidad de la implementación paralela para cada versión del filtro DNLM, desde 1 a 256 hilos de ejecución. El tama\~no de la imagen de entrada es de $1024\times1024$, con tama\~no de ventana de búsqueda de $21 \times 21$ y vencidario de $7 \times 7$ pixeles.\label{fig:scalability}}
  \end{figure}
  
  Siguiendo la misma tendencia, la eficiencia de las implementaciones paralelas se muestran en la Figura \ref{fig:efficiency}. Se aprecia que la eficiencia de las implementaciones DNLM-P y DNLM-IIFFT-P presentan una disminución sostenida en la eficiencia al aumentar la cantidad de hilos de ejecución. En el caso de la implementación DNLM-MA-P, presenta un mayor ancho de banda de memoria, por lo tanto la sobrecarga en cuanto a transferencia de datos en memoria aumenta al aumentar la cantidad de hilos de ejecución, provocando una caída considerablemente más pronunciada en la curva de eficiencia.
  
  \begin{figure}
  \centering
  \begin{tikzpicture}
      \begin{axis}[
          height=0.3\textheight,
          width=0.5\textwidth,
          xlabel= \# Hilos,
          ylabel=Eficiencia,
          xmin=1,
          xmax=260,
          %scaled x ticks = false
  ]
           \addplot[mark=*] table[x=Threads,y=Efficiency] {data/eficiency_original.txt};
           \addlegendentry{DNLM}
          \addplot[mark=x] table[x=Threads,y=Efficiency] {data/eficiency_iifft.txt};
          \addlegendentry{DNLM-IIFFT}
          \addplot[mark=triangle] table[x=Threads,y=Efficiency] {data/efficiency_condat.txt};
          \addlegendentry{DNLM-MA}
      \end{axis}
  \end{tikzpicture}
  \caption[Eficiencia de las implementaciones paralelas del filtro DNLM.]{Eficiencia de la implementación paralela para cada versión del filtro DNLM, desde 1 a 256 hilos de ejecución. El tama\~no de la imagen de entrada es de $1024\times1024$, con tama\~no de ventana de búsqueda de $21 \times 21$ y vencidario de $7 \times 7$ pixeles. \label{fig:efficiency}}
  \end{figure}
  
  
  
%Scalability table #1--------------------------------
\begin{table}
\protect\caption[Comportamiento del CPI al aumentar numero de hilos]{Effecto en CPI al cambiar númro de hilos para los filtros DNLM-P, DNLM-IIFFT-P y DNLM-MA-P usando una imagen de entrada de  $1024 \times 1024$ pixeles, con tama\~no de ventana de búsqueda de $21 \times 21$ y vencidario de $7 \times 7$ pixeles. \label{tabla:scala1}}
\centering
\begin{tabular}{lrrrrrrrrr}
Filtro & 1& 2& 4& 8& 16&32& 64 &128& 256\tabularnewline
\hline
DNLM-P& $1.95$ & $2.02$ & $2.21$ &  $2.15$ &  $2.34$ & $2.42$  & $2.55$  & $3.04 $ & $3.87$ \tabularnewline
DNLM-IIFFT-P &$1.49$ & $1.78$ & $1.77$ &  $1.55$ &  $2.48$ & $2.36$  & $2.60$  & $3.12$  & $3.95$ \tabularnewline
DNLM-MA-P & $2.01$ & $2.13$ & $2.27$ &  $2.31$ &  $ 2.44$ & $2.63$  & $2.56$  & $3.01$  & $3.60$ \tabularnewline
\end{tabular}
\end{table}